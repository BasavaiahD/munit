<?xml version="1.0" encoding="UTF-8"?>


<!--


 Tests that include the usage of the dbserver for transport calls


-->
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:dbserver="http://www.mulesoft.org/schema/mule/dbserver"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/3.2/mule.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/1.0/mule-munit.xsd
        http://www.mulesoft.org/schema/mule/dbserver http://www.mulesoft.org/schema/mule/dbserver/1.0/mule-dbserver.xsd">


    <spring:beans>
        <spring:import resource="mule-config.xml"/>
    </spring:beans>

    <munit:config/>
    <dbserver:config database="test" csv="test.csv"
                     creationalScript="
    CREATE TABLE jobtitlelookup ( jobtitle VARCHAR(255), eecsalaryorhourly VARCHAR(255), jobtitleid VARCHAR(255));
    INSERT INTO jobtitlelookup (jobtitle, eecsalaryorhourly, jobtitleid) VALUES ('Culinary Team Member', 'HOURLY',3);
    INSERT INTO jobtitlelookup (jobtitle, eecsalaryorhourly, jobtitleid) VALUES ('Other', 'SALARY',9);" />

    <munit:before-suite name="before.suite" description="Starting DB server">
        <dbserver:start-db-server />
    </munit:before-suite>


    <munit:after-suite name="after.suite" description="Stopping DB server">
        <dbserver:execute sql="drop table jobtitlelookup;"/>
        <dbserver:execute sql="drop table test;"/>
        <dbserver:stop-db-server />
    </munit:after-suite>

    <munit:test name="testEnricherWhenValueExists"

          description="
        If the Job Id exist it must set the job property value with the database value">

        <message-properties-transformer scope="invocation">
            <add-message-property key="jobid" value="3" />
        </message-properties-transformer>

        <flow-ref name="enrichMessageFlow" />

        <munit:assert-on-equals expected-ref="#[string:Culinary Team Member]" value-ref="#[variable:job]" />

    </munit:test>


    <munit:test name="testEnricherWhenValueDoesNotExists"

          description="
         If the Job Id doesn't exist it must set the job property value with HIR">

        <message-properties-transformer scope="invocation">
            <add-message-property key="jobid" value="11" />
        </message-properties-transformer>

        <flow-ref name="enrichMessageFlow" />

        <munit:assert-on-equals expected-ref="#[string:HIR]" value-ref="#[variable:job]" />

    </munit:test>

    <munit:test name="databaseResult"
                description="Testing database result">

        <message-properties-transformer scope="invocation">
            <add-message-property key="jobid" value="11" />
        </message-properties-transformer>

        <flow-ref name="enrichMessageFlow" />

        <dbserver:execute-query sql="SELECT * FROM jobtitlelookup;"/>

        <dbserver:validate-that query="SELECT * FROM jobtitlelookup;"
                                returns='[{"EECSALARYORHOURLY":"HOURLY","JOBTITLE":"Culinary Team Member","JOBTITLEID":"3"},
                                          {"EECSALARYORHOURLY":"SALARY","JOBTITLE":"Other","JOBTITLEID":"9"}]'/>

        <dbserver:validate-that query="SELECT * FROM test;"
                                returns='[{"NAME":"test1","ZIP_CODE":"1001"},
                                          {"NAME":"test2","ZIP_CODE":"1002"}]'/>

    </munit:test>


</mule>